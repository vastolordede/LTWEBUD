<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý giá bán</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .sidebar { transition: transform 0.3s ease-in-out; }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="sidebar w-64 bg-gray-800 text-white p-4 fixed lg:relative h-full -translate-x-full lg:translate-x-0 z-20">
      <div class="text-2xl font-bold mb-8">Admin Panel</div>
      <nav>
        <a href="admin_dashboard.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-tachometer-alt mr-3"></i>Bảng điều khiển</a>
        <a href="admin_users.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-users mr-3"></i>Quản lý người dùng</a>
        <a href="admin_categories.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-tags mr-3"></i>Quản lý loại SP</a>
        <a href="admin_products.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-box mr-3"></i>Quản lý sản phẩm</a>
        <a href="admin_imports.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-truck-loading mr-3"></i>Quản lý nhập hàng</a>
        <a href="admin_pricing.html" class="flex items-center p-3 my-1 bg-gray-700 rounded-lg"><i class="fas fa-dollar-sign mr-3"></i>Quản lý giá bán</a>
        <a href="admin_orders.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-shopping-cart mr-3"></i>Quản lý đơn hàng</a>
        <a href="admin_inventory.html" class="flex items-center p-3 my-1 hover:bg-gray-700 rounded-lg"><i class="fas fa-warehouse mr-3"></i>Quản lý tồn kho</a>
        <a href="../index.html" class="flex items-center p-3 mt-8 hover:bg-red-700 rounded-lg"><i class="fas fa-sign-out-alt mr-3"></i>Đăng xuất</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 lg:p-10">
      <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800">Quản lý giá bán</h1>
        <button id="menu-button" class="lg:hidden text-gray-700">
          <i class="fas fa-bars fa-2x"></i>
        </button>
      </div>

      <!-- Pricing Table -->
      <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="sm:flex justify-between mb-4 gap-3">
          <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
            <input id="search-input" type="text" placeholder="Tìm theo mã/tên sản phẩm..." class="border rounded p-2 w-full sm:w-80">
            <!-- ✅ Dropdown lọc theo loại -->
            <label class="flex items-center gap-2 text-sm">
              <span>Loại:</span>
              <select id="filter-type" class="border rounded p-2 w-40">
                <option value="">Tất cả</option>
              </select>
            </label>
          </div>
          
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-200">
                <th class="p-3">Mã SP</th>
                <th class="p-3">Tên sản phẩm</th>
                <th class="p-3">Loại</th>
                <th class="p-3">Giá vốn</th>
                <th class="p-3">% Lợi nhuận</th>
                <th class="p-3">Giá bán</th>
              </tr>
            </thead>
            <tbody id="pricing-tbody">
              <!-- Render động -->
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ===== UI cơ bản =====
    const menuButton = document.getElementById('menu-button');
    const sidebar = document.querySelector('.sidebar');
    if (menuButton && sidebar) {
      menuButton.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));
    }

    // ===== Keys LocalStorage =====
    const LS_ADMIN_PRODUCTS = 'admin_products';
    const LS_INVOICES = 'invoices';
    const LS_PRICING_DATA = 'pricing_data'; // nơi lưu tất cả

    // ===== Cấu hình =====
    const DEFAULT_PROFIT = 20;         // mặc định mỗi dòng nếu chưa lưu
    const EXCLUDE_HIDDEN = true;       // ẩn sản phẩm hidden: true

    // ===== Helpers =====
    function onlyDigitsToNumber(v){ return Number(String(v||'').replace(/[^\d]/g,'')) || 0; }
    function formatVND(n){
      const num = typeof n === 'number' ? n : onlyDigitsToNumber(n);
      return num.toLocaleString('vi-VN') + 'đ';
    }
    function normalizeName(s){ return String(s||'').trim().toLowerCase(); }

    // ===== LocalStorage helpers =====
    function lsGetProducts(){
      try { return JSON.parse(localStorage.getItem(LS_ADMIN_PRODUCTS) || '[]'); }
      catch(e){ return []; }
    }
    function lsGetInvoices(){
      try { return JSON.parse(localStorage.getItem(LS_INVOICES) || '[]'); }
      catch(e){ return []; }
    }
    function lsGetPricingData(){
      try { return JSON.parse(localStorage.getItem(LS_PRICING_DATA) || '{"rows":[]}'); }
      catch(e){ return { rows: [] }; }
    }
    function lsSavePricingData(obj){
      localStorage.setItem(LS_PRICING_DATA, JSON.stringify(obj || { rows: [] }));
    }

    // ===== Lấy giá vốn theo tên từ invoices (mới nhất). Không có -> 0
    function getCostFromInvoicesByName(productName){
      const nameKey = normalizeName(productName);
      const invoices = lsGetInvoices();
      let latest = null;

      for (const inv of (invoices || [])){
        const invDateMs = new Date(inv?.date || 0).getTime() || 0;
        const list = inv?.products || [];
        for (const p of list){
          if (normalizeName(p?.name) === nameKey){
            const priceNum = Number(p?.price);
            const totalNum = Number(p?.total);
            const qtyNum   = Number(p?.quantity);
            const computed = Number.isFinite(priceNum) && priceNum > 0
              ? Math.round(priceNum)
              : (Number.isFinite(totalNum) && Number.isFinite(qtyNum) && qtyNum > 0
                  ? Math.round(totalNum / qtyNum)
                  : 0);
            if (!latest || invDateMs > latest.invDateMs){
              latest = { cost: computed, invDateMs };
            }
          }
        }
      }
      return latest ? latest.cost : 0;
    }

    // ===== Tính giá bán theo % lợi nhuận =====
    function calcSellPrice(cost, profitPercent){
      const c = Number(cost) || 0;
      const p = Number(profitPercent) || 0;
      return Math.max(0, Math.round(c * (1 + p/100)));
    }

    // ===== Lấy % lợi nhuận đã lưu cho 1 sản phẩm (theo mã) =====
    function getSavedProfitFor(ma){
      const saved = lsGetPricingData();
      const row = (saved.rows || []).find(r => r.ma === ma);
      return Number.isFinite(row?.profitPercent) && row.profitPercent >= 0 ? row.profitPercent : DEFAULT_PROFIT;
    }

    // ===== Cập nhật 1 dòng vào storage (theo mã) =====
    function updateRowInStorage({ ma, ten, loai, cost, profitPercent }){
      const data = lsGetPricingData();
      const rows = Array.isArray(data.rows) ? data.rows : [];
      const idx = rows.findIndex(r => r.ma === ma);
      const sellPrice = calcSellPrice(cost, profitPercent);
      const newRow = { ma, ten, loai, cost, profitPercent, sellPrice };
      if (idx >= 0) rows[idx] = newRow; else rows.push(newRow);
      data.rows = rows;
      data.savedAt = new Date().toISOString();
      lsSavePricingData(data);
    }

    // ===== Build row (textbox % theo dòng) =====
    function buildRow({ ma, ten, loai, cost, profitPercent }){
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      tr.dataset.ma = ma;

      const tdMa = document.createElement('td');
      tdMa.className = 'p-3 whitespace-nowrap';
      tdMa.textContent = ma || '';

      const tdTen = document.createElement('td');
      tdTen.className = 'p-3';
      tdTen.textContent = ten || '';

      const tdLoai = document.createElement('td');
      tdLoai.className = 'p-3 whitespace-nowrap';
      tdLoai.textContent = loai || '';

      const tdCost = document.createElement('td');
      tdCost.className = 'p-3 whitespace-nowrap';
      tdCost.textContent = formatVND(cost);

      const tdPercent = document.createElement('td');
      tdPercent.className = 'p-3 whitespace-nowrap';
      tdPercent.innerHTML = `
        <input type="number" min="0" step="1"
               class="profit-input border rounded p-1 w-20 text-center"
               value="${profitPercent}">
        <span class="ml-1">%</span>
      `;

      const tdPrice = document.createElement('td');
      tdPrice.className = 'p-3 font-semibold whitespace-nowrap';
      tdPrice.dataset.role = 'sellPrice';
      tdPrice.textContent = formatVND(calcSellPrice(cost, profitPercent));

      tr.appendChild(tdMa);
      tr.appendChild(tdTen);
      tr.appendChild(tdLoai);
      tr.appendChild(tdCost);
      tr.appendChild(tdPercent);
      tr.appendChild(tdPrice);

      return tr;
    }

    // ===== DOM refs =====
    const tbody = document.getElementById('pricing-tbody');
    const searchInput = document.getElementById('search-input');
    const filterType = document.getElementById('filter-type');

    // ===== Load options dropdown Loại từ admin_products =====
    function loadTypeOptions(){
      const products = lsGetProducts() || [];
      const set = new Set(
        products
          .filter(p => (EXCLUDE_HIDDEN ? !p.hidden : true))
          .map(p => String(p.loai || '').trim())
          .filter(Boolean)
      );
      // reset
      filterType.innerHTML = '<option value="">Tất cả</option>';
      [...set].sort().forEach(loai => {
        const opt = document.createElement('option');
        opt.value = loai;
        opt.textContent = loai;
        filterType.appendChild(opt);
      });
    }

    // ===== Render (kết hợp tìm kiếm + lọc loại) =====
    function renderTable(){
      const products = (lsGetProducts() || []).filter(p => EXCLUDE_HIDDEN ? !p.hidden : true);
      const kw = (searchInput.value || '').trim().toLowerCase();
      const selectedType = (filterType.value || '').trim().toLowerCase();

      while (tbody.firstChild) tbody.removeChild(tbody.firstChild);

      const filtered = products.filter(p => {
        // lọc theo keyword (mã/tên)
        const passKw = !kw || (`${p.ma||''} ${p.ten||''}`.toLowerCase().includes(kw));
        if (!passKw) return false;

        // lọc theo loại
        const loai = String(p.loai || '').trim().toLowerCase();
        const passLoai = !selectedType || loai === selectedType;
        return passLoai;
      });

      filtered.forEach(p => {
        const ma   = p.ma || '';
        const ten  = p.ten || '';
        const loai = p.loai || '';
        const cost = getCostFromInvoicesByName(ten); // không có => 0
        const profitPercent = getSavedProfitFor(ma);

        const rowEl = buildRow({ ma, ten, loai, cost, profitPercent });
        tbody.appendChild(rowEl);

        // lưu snapshot cho dòng (đảm bảo có trong storage, kèm 'loai')
        updateRowInStorage({ ma, ten, loai, cost, profitPercent });
      });
    }

    // ===== Event delegation cho textbox % lợi nhuận theo dòng =====
    tbody.addEventListener('input', (e) => {
      const target = e.target;
      if (!target.classList.contains('profit-input')) return;

      const tr = target.closest('tr');
      if (!tr) return;
      const ma = tr.dataset.ma || '';
      const tds = tr.querySelectorAll('td');

      const ten = tds[1]?.textContent?.trim() || '';  // Tên ở cột 1
      const loai = tds[2]?.textContent?.trim() || ''; // Loại ở cột 2
      const costText = tds[3]?.textContent || '0';    // Giá vốn ở cột 3
      const cost = onlyDigitsToNumber(costText);

      const profitPercent = Math.max(0, Number(target.value) || 0);

      // Tính & cập nhật giá bán hiển thị
      const priceCell = tr.querySelector('td[data-role="sellPrice"]');
      if (priceCell){
        priceCell.textContent = formatVND(calcSellPrice(cost, profitPercent));
      }

      // Lưu riêng dòng này (kèm 'loai')
      updateRowInStorage({ ma, ten, loai, cost, profitPercent });
    });

    // ===== Events chung =====
    searchInput.addEventListener('input', renderTable);
    filterType.addEventListener('change', renderTable); // ✅ thay đổi loại => render lại

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', () => {
      loadTypeOptions(); // ✅ nạp dropdown loại
      renderTable();     // render lần đầu
    });
  </script>
</body>
</html>
